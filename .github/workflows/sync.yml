name: Sync ThingSpeak to Influx + CSV

on:
  schedule:
    - cron: "*/30 * * * *"   # toutes les 30 minutes
  workflow_dispatch:          # permet déclenchement manuel

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Récupérer le repo
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2️⃣ Installer Python
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.11

      # 3️⃣ Installer les dépendances
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install influxdb-client requests

      - name: Test connexion InfluxDB
        run: |
          curl -v ${{ secrets.INFLUX_URL }}/ping -H "Authorization: Token ${{ secrets.INFLUX_TOKEN }}"

          
      # 4️⃣ Exécuter le script sync.py
      - name: Run sync.py
        run: python sync.py
        env:
          # Mets tes infos réelles ici ou utilise des secrets GitHub
          INFLUX_URL: ${{ secrets.INFLUX_URL }}
          INFLUX_TOKEN: ${{ secrets.INFLUX_TOKEN }}
          INFLUX_ORG: ${{ secrets.INFLUX_ORG }}
          INFLUX_BUCKET: ${{ secrets.INFLUX_BUCKET }}
          READ_API_KEY: ${{ secrets.READ_API_KEY }}
          CHANNEL_ID: ${{ secrets.CHANNEL_ID }}
          
          CSV_FILE: "archive_ruche.csv"

      # 5️⃣ Sauvegarder le CSV en artifact
      - name: Upload CSV artifact
        uses: actions/upload-artifact@v4
        with:
          name: archive_ruche
          path: archive_ruche.csv
